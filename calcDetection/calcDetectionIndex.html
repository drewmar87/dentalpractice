<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculus & Plaque Charting</title>

    <!-- Add CDN links for jsPDF and html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .main-title { /* Style for the new title */
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            width: 100%;
        }
		#patient-info { /* Style for the new patient info section */
            display: flex;
            justify-content: center;
            align-items: center; /* ADD THIS LINE */
            gap: 20px;
            margin-bottom: 30px;
            padding: 10px 15px; /* Slightly increase horizontal padding */
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            width: fit-content; /* Adjust width based on content */
            transition: opacity 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        #patient-info label {
            font-weight: bold;
            margin-right: 5px;
            color: #555;
        }
        #patient-info input {
            padding: 5px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        /* Styles for locked patient info inputs */
        #patient-info.locked input {
            background-color: #e9e9e9;
            cursor: not-allowed;
            border-color: #bbb;
            color: #555;
        }
        #patient-info.locked { /* Style container when locked */
             opacity: 0.7;
             border-color: #999;
             background-color: #f0f0f0;
        }


        .chart-container {
            margin-bottom: 40px;
            text-align: center;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            background-color: #fdfdfd;
            transition: opacity 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        .chart-container.locked {
            opacity: 0.7; border-color: #999; background-color: #f0f0f0;
        }
        .chart-container.locked .surface,
        .chart-container.locked .toggle-btn {
            cursor: not-allowed !important; pointer-events: none;
        }
        .chart-container.locked .toggle-btn { opacity: 0.6; }

        .container-scaler {
            display: block;
            max-width: 1400px;
            width: 95%;
        }
        h1, h2 { margin-bottom: 15px; margin-top: 0; }
        .chart-layout {
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto;
            gap: 20px; justify-items: center; align-items: start;
            width: fit-content; margin: 10px auto 0 auto;
        }

        /* Toggle buttons */
        .toggle-area { display: flex; justify-content: center; gap: 15px; margin: 10px 0; }
        .toggle-btn {
            padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; user-select: none;
            font-weight: bold; background-color: #eee; color: #333; transition: background-color 0.2s, transform 0.1s, opacity 0.3s;
            -webkit-print-color-adjust: exact !important; color-adjust: exact !important;
        }
        .toggle-btn:hover { background-color: #ddd; }
        .toggle-btn:active { transform: scale(0.98); }
        .toggle-btn.active.supra { background-color: #4caf50; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-btn.active.both { background-color: #ff9800; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-btn.active.sub { background-color: #2196f3; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-btn.active.plaque { background-color: #ff80ab; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Base style for Action Buttons */
        .action-button {
            padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; user-select: none;
            font-weight: bold; background-color: #eee; color: #333;
            transition: background-color 0.2s, transform 0.1s, border 0.2s, color 0.2s, opacity 0.3s;
            margin: 5px; font-size: 0.9em; display: inline-block; border: 1px solid transparent;
             -webkit-print-color-adjust: exact !important; color-adjust: exact !important;
        }
        .action-button:hover:not(:disabled) { background-color: #ddd; }
        .action-button:active:not(:disabled) { transform: scale(0.98); }
        .action-button:disabled { cursor: not-allowed; opacity: 0.6; }


        /* Quadrant, Tooth, Surface Grid */
        .quadrant { border: 1px solid #ccc; border-radius: 8px; padding: 10px; background: #f9f9f9; box-sizing: border-box; width: 100%; }
        .quadrant h3 { margin: 0 0 10px; font-size: 1em; text-align: center; }
        .tooth-grid { display: flex; gap: 10px; justify-content: center; }
        .tooth { border-right: 1px dotted #aaa; padding-right: 10px; }
        .tooth:last-child { border-right: none; padding-right: 0; }
        .tooth label { display: block; font-size: 1em; font-weight: bold; color: #333; margin-bottom: 6px; text-align: center; }
        .surface-grid {
            display: grid; grid-template-columns: 30px 2px 30px; grid-template-rows: 30px 30px 30px;
            grid-template-areas: ". L ." "M . D" ". B .";
            row-gap: 2px; column-gap: 0px; justify-items: center; align-items: center;
        }
        .surface {
            width: 30px; height: 30px; border: 1px solid #888; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.2em; user-select: none;
            box-sizing: border-box; background-color: #fff; transition: background-color 0.2s, border 0.2s, opacity 0.3s;
            -webkit-print-color-adjust: exact !important; color-adjust: exact !important;
        }
        .surface[data-surface="M"] { grid-area: M; } .surface[data-surface="D"] { grid-area: D; }
        .surface[data-surface="B"] { grid-area: B; } .surface[data-surface="L"] { grid-area: L; }

        /* State Colors/Styles */
        .surface.supra { background-color: rgba(0, 128, 0, 0.2); } .surface.sub { background-color: rgba(0, 0, 255, 0.2); }
        .surface.both { background-color: rgba(255, 165, 0, 0.2); } .surface.plaque { border: 3px solid #ff80ab !important; }

        /* Comparison Highlight Styles */
        .surface.diff-faculty2 { background-color: rgba(128, 0, 128, 0.4) !important; }
        .surface.diff-faculty1 { background-color: rgba(255, 0, 0, 0.4) !important; }

        /* Active states for comparison buttons */
        .action-button.active-compare-f1 { background-color: rgba(255, 0, 0, 0.4); color: white; border: 1px solid rgba(200, 0, 0, 0.6); }
        .action-button.active-compare-f2 { background-color: rgba(128, 0, 128, 0.4); color: white; border: 1px solid rgba(100, 0, 100, 0.6); }
        .action-button.active-compare-both { background-color: rgba(255, 0, 0, 0.4); color: white; border: 1px solid rgba(200, 0, 0, 0.6); }

        /* Comparison Controls Area */
        #comparison-controls {
            text-align: center; margin: 20px auto; max-width: 600px; padding: 15px;
            border: 1px dashed #ccc; border-radius: 8px;
        }
        /* PDF Download & Lock Button Area */
         #pdf-controls { text-align: center; margin: 10px 0 30px 0; }

        /* Styles for Hiding/Showing Faculty 2 */
        #faculty2-container { display: none; } #faculty2-container.visible { display: block; }
        .f2-compare-button { display: none; } .f2-compare-button.visible { display: inline-block; }

        /* Hide controls when printing PDF */
        .pdf-generating .main-title, /* Also hide main title *during* generation if desired */
        .pdf-generating #patient-info, /* Hide patient info div during generation */
        .pdf-generating #comparison-controls,
        .pdf-generating #pdf-controls,
        .pdf-generating #toggle-f2-btn {
             display: none !important;
        }
    </style>
</head>
<body>

    <!-- NEW: Main Title -->
    <h1 class="main-title">Calculus Detection Chart</h1>

    <!-- NEW: Patient Info Section -->
    <div id="patient-info">
        <label for="patient-id">Patient ID:</label>
        <input type="text" id="patient-id" name="patient-id">

        <label for="chart-date">Date:</label>
        <input type="date" id="chart-date" name="chart-date"> <!-- Using type="date" for convenience -->
    </div>


    <div class="container-scaler">

        <!-- Student Chart Area -->
        <div class="chart-container" id="student-container">
            <h2>Student Chart</h2>
            <div class="toggle-area" id="student-toggle-area"></div>
            <div class="chart-layout" id="student-chart"></div>
        </div>

        <!-- Comparison Controls Area -->
        <div id="comparison-controls">
            <button id="compare-f1-btn" class="action-button">Compare w/ Faculty 1</button>
            <button id="compare-f2-btn" class="f2-compare-button action-button">Compare w/ Faculty 2</button>
            <button id="compare-both-btn" class="f2-compare-button action-button">Compare w/ Both</button>
            <button id="clear-compare-btn" class="action-button">Clear Comparison Highlights</button>
        </div>

        <!-- PDF Download & Lock Controls -->
         <div id="pdf-controls">
             <button id="download-pdf-btn" class="action-button">Download Chart as PDF</button>
             <button id="lock-chart-btn" class="action-button">Lock Charts</button>
         </div>


        <!-- Faculty Check 1 Chart Area -->
        <div class="chart-container" id="faculty1-container">
            <h2>Faculty Check 1</h2>
            <div class="toggle-area" id="faculty1-toggle-area"></div>
            <div class="chart-layout" id="faculty1-chart"></div>
        </div>

         <!-- Toggle Button for Faculty 2 -->
         <div style="text-align: center; margin-bottom: 20px;" id="toggle-f2-div">
             <button id="toggle-f2-btn" class="action-button">Show Faculty Check 2</button>
        </div>


        <!-- Faculty Check 2 Chart Area (Initially hidden via CSS) -->
        <div class="chart-container" id="faculty2-container">
            <h2>Faculty Check 2</h2>
            <div class="toggle-area" id="faculty2-toggle-area"></div>
            <div class="chart-layout" id="faculty2-chart"></div>
        </div>

    </div><!-- End Scaler -->

    <script>
        // Wrap entire script in an IIFE
        (function() {
            'use strict';

            const { jsPDF } = window.jspdf;

            // --- Constants and Configuration ---
            const SYMBOLS = ["", "│", "○", "●"];
            const QUADRANT_ORDER = ['Upper Left', 'Upper Right', 'Lower Left', 'Lower Right'];
            const QUADRANTS = {
                'Upper Left': [9, 10, 11, 12, 13, 14, 15, 16],'Upper Right': [1, 2, 3, 4, 5, 6, 7, 8],
                'Lower Left': [17, 18, 19, 20, 21, 22, 23, 24],'Lower Right': [25, 26, 27, 28, 29, 30, 31, 32]
            };
            const QUADRANT_POS = {
                'Upper Left': { col: 2, row: 1 }, 'Upper Right': { col: 1, row: 1 },
                'Lower Left': { col: 2, row: 2 }, 'Lower Right': { col: 1, row: 2 }
            };
            const SURFACES = ['M', 'D', 'B', 'L'];
            const CHART_IDS = ['student', 'faculty1', 'faculty2'];
            const ALL_TOOTH_NUMBERS = [].concat(...Object.values(QUADRANTS));
            const UNLOCK_CODE = "12345";
            const PDF_TITLE = "Calculus Detection Chart"; // Title for PDF

            // --- State Variables ---
            let chartData = {};
            let chartModes = {};
            let areChartsLocked = false;

            // --- DOM Element Cache ---
            const domElements = {
                chartContainers: {}, toggleAreas: {}, chartLayouts: {},
                compareF1Btn: null, compareF2Btn: null, compareBothBtn: null, clearCompareBtn: null,
                toggleF2Btn: null, faculty2Container: null, f2CompareButtons: null,
                pdfButton: null, lockChartBtn: null, studentChartLayout: null,
                patientInfoContainer: null, // NEW: Patient info div
                patientIdInput: null,      // NEW: Patient ID input
                chartDateInput: null       // NEW: Date input
            };

            // --- Core Functions --- (initializeState, updateCellUI, createToggleButtons, handleModeChange, createChartElements, handleSurfaceClick, clearComparisonHighlights, runComparison remain the same)

            /** Initializes the data structures and lock state. */
            function initializeState() {
                areChartsLocked = false;
                CHART_IDS.forEach(chartId => {
                    chartData[chartId] = {};
                    chartModes[chartId] = { currentLoc: 'supra', plaqueMode: false };
                    ALL_TOOTH_NUMBERS.forEach(toothNum => {
                        chartData[chartId][toothNum] = {};
                        SURFACES.forEach(surface => {
                            chartData[chartId][toothNum][surface] = { calc: 0, plaque: false, calcType: null };
                        });
                    });
                });
                 // Set default date (optional)
                 if(domElements.chartDateInput && !domElements.chartDateInput.value) {
                     try {
                         domElements.chartDateInput.valueAsDate = new Date();
                     } catch(e) {
                         console.warn("Could not set default date.");
                     }
                 }
            }

            /** Updates the visual appearance of a single tooth surface cell. */
            function updateCellUI(chartId, toothNum, surface) {
                const cellSelector = `.surface[data-chart-id="${chartId}"][data-tooth-num="${toothNum}"][data-surface="${surface}"]`;
                const chartLayout = domElements.chartLayouts[chartId];
                const cell = chartLayout ? chartLayout.querySelector(cellSelector) : null;
                if (!cell) return;
                const data = chartData[chartId][toothNum][surface];
                cell.textContent = SYMBOLS[data.calc];
                cell.classList.remove('supra', 'sub', 'both', 'plaque', 'diff-faculty1', 'diff-faculty2');
                if (data.calc > 0 && data.calcType) cell.classList.add(data.calcType);
                if (data.plaque) cell.classList.add('plaque');
            }

             /** Creates the mode toggle buttons. */
             function createToggleButtons(chartId, toggleAreaElement) {
                 if (!toggleAreaElement) return;
                 toggleAreaElement.innerHTML = '';
                 const createButton = (mode, text) => {
                     const btn = document.createElement('div');
                     btn.className = `toggle-btn ${mode}`; btn.textContent = text;
                     btn.addEventListener('click', () => handleModeChange(chartId, mode, toggleAreaElement));
                     return btn;
                 };
                 const supraBtn = createButton('supra', 'Supra'); const bothBtn = createButton('both', 'Both');
                 const subBtn = createButton('sub', 'Sub'); const plaqueBtn = createButton('plaque', 'Plaque');
                 if (!chartModes[chartId].plaqueMode) {
                      const currentCalcMode = chartModes[chartId].currentLoc || 'supra';
                      const activeCalcButton = [supraBtn, bothBtn, subBtn].find(btn => btn.classList.contains(currentCalcMode));
                      if (activeCalcButton) activeCalcButton.classList.add('active');
                      else { supraBtn.classList.add('active'); chartModes[chartId].currentLoc = 'supra'; }
                 } else plaqueBtn.classList.add('active');
                 toggleAreaElement.append(supraBtn, bothBtn, subBtn, plaqueBtn);
             }

             /** Handles clicks on the mode toggle buttons, preventing changes if locked. */
            function handleModeChange(chartId, mode, toggleAreaElement) {
                if (areChartsLocked) { console.log("Charts are locked. Cannot change mode."); return; }
                const currentMode = chartModes[chartId]; const buttons = toggleAreaElement.querySelectorAll('.toggle-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                if (mode === 'plaque') {
                    currentMode.plaqueMode = !currentMode.plaqueMode;
                    if (currentMode.plaqueMode) toggleAreaElement.querySelector('.plaque').classList.add('active');
                    else { const calcButton = toggleAreaElement.querySelector(`.${currentMode.currentLoc}`); if (calcButton) calcButton.classList.add('active'); }
                } else {
                    currentMode.plaqueMode = false; currentMode.currentLoc = mode;
                    toggleAreaElement.querySelector(`.${mode}`).classList.add('active');
                }
            }

            /** Creates the HTML elements for a complete chart. */
            function createChartElements(chartId, chartLayoutElement) {
                if (!chartLayoutElement) return;
                chartLayoutElement.innerHTML = '';
                QUADRANT_ORDER.forEach(key => {
                    const pos = QUADRANT_POS[key]; const quadDiv = document.createElement('div');
                    quadDiv.className = 'quadrant'; quadDiv.style.gridColumn = pos.col; quadDiv.style.gridRow = pos.row;
                    const h3 = document.createElement('h3'); h3.textContent = key; quadDiv.append(h3);
                    const toothGridDiv = document.createElement('div'); toothGridDiv.className = 'tooth-grid';
                    const teethNumbers = QUADRANTS[key];
                    teethNumbers.forEach(num => {
                        const toothDiv = document.createElement('div'); toothDiv.className = 'tooth';
                        const label = document.createElement('label'); label.textContent = num; toothDiv.append(label);
                        const surfaceGridDiv = document.createElement('div'); surfaceGridDiv.className = 'surface-grid';
                        SURFACES.forEach(s => {
                            const cell = document.createElement('div'); cell.className = 'surface';
                            cell.dataset.chartId = chartId; cell.dataset.toothNum = num; cell.dataset.surface = s;
                            cell.addEventListener('click', handleSurfaceClick); surfaceGridDiv.append(cell);
                        });
                        toothDiv.append(surfaceGridDiv); toothGridDiv.append(toothDiv);
                    });
                    quadDiv.append(toothGridDiv); chartLayoutElement.append(quadDiv);
                });
            }

            /** Handles clicks on individual tooth surface cells, preventing changes if locked. */
            function handleSurfaceClick(event) {
                if (areChartsLocked) { console.log("Charts are locked. Cannot modify surface."); return; }
                const cell = event.currentTarget; const { chartId, toothNum, surface } = cell.dataset;
                const mode = chartModes[chartId]; const data = chartData[chartId][toothNum][surface];
                if (mode.plaqueMode) data.plaque = !data.plaque;
                else {
                    data.calc = (data.calc + 1) % SYMBOLS.length;
                    data.calcType = (data.calc > 0) ? mode.currentLoc : null;
                }
                updateCellUI(chartId, toothNum, surface);
                if (chartId === 'student') cell.classList.remove('diff-faculty1', 'diff-faculty2');
            }

            /** Clears all comparison highlights from the student chart and resets button states. */
            function clearComparisonHighlights() {
                if (!domElements.studentChartLayout) return;
                const surfacesToClear = domElements.studentChartLayout.querySelectorAll('.surface');
                surfacesToClear.forEach(cell => cell.classList.remove('diff-faculty1', 'diff-faculty2'));
                domElements.compareF1Btn?.classList.remove('active-compare-f1');
                domElements.compareF2Btn?.classList.remove('active-compare-f2');
                domElements.compareBothBtn?.classList.remove('active-compare-both');
            }

             /** Runs comparison and highlights differences on the student chart. */
            function runComparison(compareF1, compareF2) {
                clearComparisonHighlights(); if (!domElements.studentChartLayout) return;
                ALL_TOOTH_NUMBERS.forEach(toothNum => {
                    SURFACES.forEach(surface => {
                        const studentState = chartData.student[toothNum]?.[surface]; if (!studentState) return;
                        let isDiffF1 = false, isDiffF2 = false;
                        if (compareF1 && chartData.faculty1[toothNum]?.[surface]) { const f1State = chartData.faculty1[toothNum][surface]; if (studentState.calc !== f1State.calc || studentState.calcType !== f1State.calcType) isDiffF1 = true; }
                        if (compareF2 && chartData.faculty2[toothNum]?.[surface]) { const f2State = chartData.faculty2[toothNum][surface]; if (studentState.calc !== f2State.calc || studentState.calcType !== f2State.calcType) isDiffF2 = true; }
                        const cellSelector = `.surface[data-tooth-num="${toothNum}"][data-surface="${surface}"]`; const cell = domElements.studentChartLayout.querySelector(cellSelector);
                        if (cell) { if (isDiffF1) cell.classList.add('diff-faculty1'); if (isDiffF2) cell.classList.add('diff-faculty2'); }
                    });
                });
                 if (compareF1 && compareF2) domElements.compareBothBtn?.classList.add('active-compare-both');
                 else if (compareF1) domElements.compareF1Btn?.classList.add('active-compare-f1');
                 else if (compareF2) domElements.compareF2Btn?.classList.add('active-compare-f2');
            }

            // --- PDF Generation (Manual Text Addition) ---
            async function generatePdf() {
                 if (!domElements.pdfButton || areChartsLocked) {
                     if(areChartsLocked) alert("Cannot generate PDF while charts are locked. Please unlock first.");
                     return;
                 }

                 console.log("Running comparison before PDF generation...");
                 const faculty2Visible = domElements.faculty2Container?.classList.contains('visible');
                 runComparison(true, faculty2Visible);

                 domElements.pdfButton.textContent = 'Generating PDF...';
                 domElements.pdfButton.disabled = true;
                 domElements.lockChartBtn.disabled = true;
                 document.body.classList.add('pdf-generating'); // Hide controls via CSS

                 // Get Patient Info Values
                 const patientId = domElements.patientIdInput?.value || 'N/A';
                 const chartDate = domElements.chartDateInput?.value || 'N/A'; // Format YYYY-MM-DD if type="date"

                 try {
                     const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
                     const pdfWidth = pdf.internal.pageSize.getWidth();
                     const pdfHeight = pdf.internal.pageSize.getHeight();
                     const margin = 40; // Increased margin slightly for header space
                     const usableWidth = pdfWidth - 2 * margin;
                     let usableHeight = pdfHeight - 2 * margin; // Will adjust this below image

                     // --- Helper to add Header Text (Title, ID, Date) to the CURRENT page ---
                     function addHeader(pdfInstance) {
                         const headerStartY = margin / 2; // Start header text near top margin
                         const titleFontSize = 16;
                         const infoFontSize = 10;

                         pdfInstance.setFontSize(titleFontSize);
                         pdfInstance.setFont(undefined, 'bold'); // Set font to bold for title
                         pdfInstance.text(PDF_TITLE, pdfWidth / 2, headerStartY + titleFontSize, { align: 'center' });

                         pdfInstance.setFontSize(infoFontSize);
                         pdfInstance.setFont(undefined, 'normal'); // Reset font style
                         const infoY = headerStartY + titleFontSize + infoFontSize + 5; // Position below title
                         pdfInstance.text(`Patient ID: ${patientId}`, margin, infoY); // Left align ID
                         pdfInstance.text(`Date: ${chartDate}`, pdfWidth - margin, infoY, { align: 'right' }); // Right align Date

                         // Return the Y position where the chart image should start
                         return infoY + infoFontSize + 10; // Add some padding below the info line
                     }

                     // --- Helper function to add chart image ---
                    async function addChartToPdf(chartElementId, pdfInstance, isFirstPage, startY) {
                        const element = document.getElementById(chartElementId);
                        if (!element || (element.id === 'faculty2-container' && !element.classList.contains('visible'))) {
                            return false;
                        }
                        if (!isFirstPage) pdfInstance.addPage();

                        // Add Header to the new/current page *before* adding the image
                        const imageStartY = addHeader(pdfInstance);
                        const availableHeightForImage = pdfHeight - margin - imageStartY; // Height remaining for image

                        const canvas = await html2canvas(element, { scale: 2, useCORS: true, logging: false });
                        const imgData = canvas.toDataURL('image/png');
                        const imgProps = pdfInstance.getImageProperties(imgData);

                        // Calculate scaling based on usable width and *remaining* height
                        const ratio = Math.min(usableWidth / imgProps.width, availableHeightForImage / imgProps.height);
                        const scaledWidth = imgProps.width * ratio;
                        const scaledHeight = imgProps.height * ratio;

                        // Center the image horizontally within margins, position vertically below header
                        const x = margin + (usableWidth - scaledWidth) / 2;
                        const y = imageStartY; // Start image right below header

                        pdfInstance.addImage(imgData, 'PNG', x, y, scaledWidth, scaledHeight);
                        return true;
                    }

                    // --- Process Charts ---
                    let chartProcessed = false;
                    // AddHeader is called *inside* addChartToPdf for each page
                    chartProcessed = await addChartToPdf('student-container', pdf, true); // First page
                    chartProcessed = await addChartToPdf('faculty1-container', pdf, !chartProcessed); // Add page if needed
                    if (faculty2Visible) {
                        await addChartToPdf('faculty2-container', pdf, !chartProcessed); // Add page if needed
                    }
                    pdf.save(`${PDF_TITLE.replace(/\s+/g, '_')}_${patientId}_${chartDate}.pdf`); // More descriptive filename

                 } catch (error) {
                     console.error("Error generating PDF:", error);
                     alert("Sorry, an error occurred generating the PDF.");
                 } finally {
                     domElements.pdfButton.textContent = 'Download Chart as PDF';
                     // Only re-enable if charts aren't locked
                     if (!areChartsLocked) {
                         domElements.pdfButton.disabled = false;
                         domElements.lockChartBtn.disabled = false;
                     }
                     document.body.classList.remove('pdf-generating');
                 }
            }


            // --- Lock/Unlock Logic (Includes Patient Info) ---
            function lockAllCharts() {
                if (!domElements.lockChartBtn) return;
                areChartsLocked = true;

                // Lock Chart Containers
                CHART_IDS.forEach(id => {
                    const container = domElements.chartContainers[id];
                    if (container && (id !== 'faculty2' || container.classList.contains('visible'))) {
                        container.classList.add('locked');
                    }
                });

                // Lock Patient Info Section
                domElements.patientInfoContainer?.classList.add('locked');
                if (domElements.patientIdInput) domElements.patientIdInput.readOnly = true;
                if (domElements.chartDateInput) domElements.chartDateInput.readOnly = true;


                // Update Buttons
                domElements.lockChartBtn.textContent = 'Unlock Charts';
                domElements.lockChartBtn.disabled = false;
                domElements.pdfButton.disabled = true;
                domElements.compareF1Btn.disabled = true;
                domElements.compareF2Btn.disabled = true;
                domElements.compareBothBtn.disabled = true;
                domElements.clearCompareBtn.disabled = true;
                console.log("All active charts and info LOCKED.");
            }

            function unlockAllCharts() {
                 if (!domElements.lockChartBtn) return;
                 const enteredCode = prompt("Enter unlock code:");
                 if (enteredCode === null) return;

                 if (enteredCode === UNLOCK_CODE) {
                    areChartsLocked = false;
                    // Unlock Chart Containers
                    CHART_IDS.forEach(id => {
                        domElements.chartContainers[id]?.classList.remove('locked');
                    });

                    // Unlock Patient Info Section
                    domElements.patientInfoContainer?.classList.remove('locked');
                    if (domElements.patientIdInput) domElements.patientIdInput.readOnly = false;
                    if (domElements.chartDateInput) domElements.chartDateInput.readOnly = false;


                    // Update Buttons
                    domElements.lockChartBtn.textContent = 'Lock Charts';
                    domElements.pdfButton.disabled = false;
                    domElements.compareF1Btn.disabled = false;
                    domElements.compareF2Btn.disabled = false;
                    domElements.compareBothBtn.disabled = false;
                    domElements.clearCompareBtn.disabled = false;
                    console.log("All charts and info UNLOCKED.");
                 } else {
                     alert("Incorrect code. Charts remain locked.");
                 }
            }

            // --- Setup Functions ---

            /** Finds and stores references to key DOM elements. */
            function cacheDomElements() {
                CHART_IDS.forEach(id => {
                    domElements.chartContainers[id] = document.getElementById(`${id}-container`);
                    domElements.toggleAreas[id] = document.getElementById(`${id}-toggle-area`);
                    domElements.chartLayouts[id] = document.getElementById(`${id}-chart`);
                });
                domElements.compareF1Btn = document.getElementById('compare-f1-btn');
                domElements.compareF2Btn = document.getElementById('compare-f2-btn');
                domElements.compareBothBtn = document.getElementById('compare-both-btn');
                domElements.clearCompareBtn = document.getElementById('clear-compare-btn');
                domElements.toggleF2Btn = document.getElementById('toggle-f2-btn');
                domElements.faculty2Container = document.getElementById('faculty2-container');
                domElements.f2CompareButtons = document.querySelectorAll('.f2-compare-button');
                domElements.pdfButton = document.getElementById('download-pdf-btn');
                domElements.lockChartBtn = document.getElementById('lock-chart-btn');
                domElements.studentChartLayout = document.getElementById('student-chart');
                // NEW Caching
                domElements.patientInfoContainer = document.getElementById('patient-info');
                domElements.patientIdInput = document.getElementById('patient-id');
                domElements.chartDateInput = document.getElementById('chart-date');
            }

             /** Creates the initial UI for all charts & sets initial lock state UI. */
            function setupChartUI() {
                CHART_IDS.forEach(id => {
                    createToggleButtons(id, domElements.toggleAreas[id]);
                    createChartElements(id, domElements.chartLayouts[id]);
                    ALL_TOOTH_NUMBERS.forEach(toothNum => {
                        SURFACES.forEach(surface => updateCellUI(id, toothNum, surface));
                    });
                });

                // Initialize lock state UI correctly
                const isInitiallyLocked = areChartsLocked; // Should be false
                if (domElements.lockChartBtn) domElements.lockChartBtn.textContent = isInitiallyLocked ? 'Unlock Charts' : 'Lock Charts';

                CHART_IDS.forEach(id => domElements.chartContainers[id]?.classList.toggle('locked', isInitiallyLocked));
                domElements.patientInfoContainer?.classList.toggle('locked', isInitiallyLocked);
                if(domElements.patientIdInput) domElements.patientIdInput.readOnly = isInitiallyLocked;
                if(domElements.chartDateInput) domElements.chartDateInput.readOnly = isInitiallyLocked;

                domElements.pdfButton.disabled = isInitiallyLocked;
                domElements.compareF1Btn.disabled = isInitiallyLocked;
                domElements.compareF2Btn.disabled = isInitiallyLocked;
                domElements.compareBothBtn.disabled = isInitiallyLocked;
                domElements.clearCompareBtn.disabled = isInitiallyLocked;
            }

            /** Attaches event listeners to the comparison control buttons. */
            function setupComparisonControls() { /* No changes needed */
                domElements.compareF1Btn?.addEventListener('click', () => runComparison(true, false));
                domElements.compareF2Btn?.addEventListener('click', () => { if (domElements.faculty2Container?.classList.contains('visible')) runComparison(false, true); else alert("Please show Faculty Check 2 chart first."); });
                 domElements.compareBothBtn?.addEventListener('click', () => { if (domElements.faculty2Container?.classList.contains('visible')) runComparison(true, true); else alert("Please show Faculty Check 2 chart first."); });
                domElements.clearCompareBtn?.addEventListener('click', clearComparisonHighlights);
            }

            /** Attaches event listener for toggling the Faculty 2 chart visibility and lock state. */
            function setupFaculty2Toggle() { /* No changes needed for lock logic here, handled globally */
                if (!domElements.toggleF2Btn || !domElements.faculty2Container || !domElements.f2CompareButtons) {
                    console.error("Could not find elements for F2 toggle."); if(domElements.toggleF2Btn) domElements.toggleF2Btn.parentElement.style.display = 'none'; return; }
                domElements.toggleF2Btn.addEventListener('click', () => {
                    const f2Container = domElements.faculty2Container; const f2Buttons = domElements.f2CompareButtons;
                    const toggleBtn = domElements.toggleF2Btn; f2Container.classList.toggle('visible');
                    const isVisible = f2Container.classList.contains('visible');
                    f2Buttons.forEach(btn => btn.classList.toggle('visible', isVisible));
                    toggleBtn.textContent = isVisible ? 'Hide Faculty Check 2' : 'Show Faculty Check 2';
                    // Apply/remove lock *if* globally locked
                    if (areChartsLocked) f2Container.classList.toggle('locked', isVisible);
                    // Clear comparison if needed
                    if (!isVisible) { const f2Active = domElements.compareF2Btn?.classList.contains('active-compare-f2'); const bothActive = domElements.compareBothBtn?.classList.contains('active-compare-both'); if (f2Active || bothActive) clearComparisonHighlights(); }
                });
            }

            /** Attaches event listener to the PDF download button. */
            function setupPdfButton() { /* No changes needed */
                if (!domElements.pdfButton) { console.error("PDF button not found."); return; }
                domElements.pdfButton.addEventListener('click', generatePdf);
            }

            /** Attaches event listener to the Lock/Unlock button. */
            function setupLockUnlockButton() { /* No changes needed */
                if (!domElements.lockChartBtn) { console.error("Lock/Unlock button not found."); return; }
                domElements.lockChartBtn.addEventListener('click', () => { if (areChartsLocked) unlockAllCharts(); else lockAllCharts(); });
            }

            // --- Initialization ---
            function init() {
                cacheDomElements();
                initializeState(); // Sets default date if input available
                setupChartUI();
                setupComparisonControls();
                setupFaculty2Toggle();
                setupPdfButton();
                setupLockUnlockButton();
            }

            // --- Run ---
            document.addEventListener('DOMContentLoaded', init);

        })(); // End of IIFE
    </script>

</body>
</html>
