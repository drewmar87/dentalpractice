<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculus & Plaque Charting</title>

    <!-- Add CDN links for jsPDF and html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;

        }
        .main-title { /* Style for the new title */
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            width: 100%;
        }
        #patient-info { /* Style for the new patient info section */
            display: flex;
            justify-content: center;
            align-items: center; /* ADD THIS LINE */
            gap: 20px;
            margin-bottom: 30px;
            padding: 10px 15px; /* Slightly increase horizontal padding */
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            width: fit-content; /* Adjust width based on content */
            transition: opacity 0.3s ease-in-out, border-color 0.3s ease-in-out;
            flex-wrap: wrap; /* Allow wrapping on very small screens */
        }
        #patient-info label {
            font-weight: bold;
            margin-right: 5px;
            color: #555;
        }
        #patient-info input {
            padding: 5px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        /* Styles for locked patient info inputs */
        #patient-info.locked input {
            background-color: #e9e9e9;
            cursor: not-allowed;
            border-color: #bbb;
            color: #555;
        }
        #patient-info.locked { /* Style container when locked */
             opacity: 0.7;
             border-color: #999;
             background-color: #f0f0f0;
        }

        .chart-container {
            margin-bottom: 40px;
            text-align: center;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            background-color: #fdfdfd;
            transition: opacity 0.3s ease-in-out, border-color 0.3s ease-in-out;
            width: 100%; /* Ensure container uses available width */
            box-sizing: border-box;
        }
        .chart-container.locked {
            opacity: 0.7; border-color: #999; background-color: #f0f0f0;
        }
        .chart-container.locked .surface,
        .chart-container.locked .toggle-btn {
            cursor: not-allowed !important; pointer-events: none;
        }
        .chart-container.locked .toggle-btn { opacity: 0.6; }

        /* Container scaler adjusted slightly */
        .container-scaler {
            display: block;
            max-width: 1400px; /* Keep max width */
            width: 95%; /* Use percentage width */
            margin-left: auto;
            margin-right: auto;
        }
        h1, h2 { margin-bottom: 15px; margin-top: 0; }
        .chart-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); /* More responsive grid */
            grid-template-rows: auto;
            gap: 20px;
            justify-items: center;
            align-items: start;
            width: 100%; /* Use full width */
            margin: 10px auto 0 auto;
            box-sizing: border-box;
        }

        /* Toggle buttons */
        .toggle-area { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 10px 0; } /* Allow wrap */
        .toggle-btn {
            padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; user-select: none;
            font-weight: bold; background-color: #eee; color: #333; transition: background-color 0.2s, transform 0.1s, opacity 0.3s;
            -webkit-print-color-adjust: exact !important; color-adjust: exact !important;
        }
        .toggle-btn:hover { background-color: #ddd; }
        .toggle-btn:active { transform: scale(0.98); }
        .toggle-btn.active.supra { background-color: #4caf50; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-btn.active.both { background-color: #ff9800; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-btn.active.sub { background-color: #2196f3; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-btn.active.plaque { background-color: #ff80ab; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Base style for Action Buttons */
        .action-button {
            padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; user-select: none;
            font-weight: bold; background-color: #eee; color: #333;
            transition: background-color 0.2s, transform 0.1s, border 0.2s, color 0.2s, opacity 0.3s;
            margin: 5px; font-size: 0.9em; display: inline-block; border: 1px solid transparent;
             -webkit-print-color-adjust: exact !important; color-adjust: exact !important;
        }
        .action-button:hover:not(:disabled) { background-color: #ddd; }
        .action-button:active:not(:disabled) { transform: scale(0.98); }
        .action-button:disabled { cursor: not-allowed; opacity: 0.6; }


        /* Quadrant, Tooth, Surface Grid */
        .quadrant {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            background: #f9f9f9;
            box-sizing: border-box;
            width: 100%; /* Take width from grid column */
        }
        .quadrant h3 { margin: 0 0 10px; font-size: 1em; text-align: center; }

        /* --- MODIFIED SECTION --- */
        .tooth-grid {
            display: flex;
            gap: 10px;
            justify-content: flex-start;  /* Align items to the start for better scroll */
            overflow-x: auto;         /* ADDED: Allow horizontal scrolling if content overflows */
            padding-bottom: 8px;       /* ADDED: Add space below for scrollbar visibility */
            width: 100%;               /* Ensure it uses quadrant width */
            box-sizing: border-box;
        }
        .tooth {
            border-right: 1px dotted #aaa;
            padding-right: 10px;
            flex-shrink: 0;           /* ADDED: Prevent teeth from shrinking */
            box-sizing: border-box;   /* Good practice */
        }
         /* --- END MODIFIED SECTION --- */

        .tooth:last-child { border-right: none; padding-right: 0; }
        .tooth label { display: block; font-size: 1em; font-weight: bold; color: #333; margin-bottom: 6px; text-align: center; }
        .surface-grid {
            display: grid; grid-template-columns: 30px 2px 30px; grid-template-rows: 30px 30px 30px;
            grid-template-areas: ". L ." "M . D" ". B .";
            row-gap: 2px; column-gap: 0px; justify-items: center; align-items: center;
        }
        .surface {
            width: 30px; height: 30px; border: 1px solid #888; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.2em; user-select: none;
            box-sizing: border-box; background-color: #fff; transition: background-color 0.2s, border 0.2s, opacity 0.3s;
            -webkit-print-color-adjust: exact !important; color-adjust: exact !important;
        }
        .surface[data-surface="M"] { grid-area: M; } .surface[data-surface="D"] { grid-area: D; }
        .surface[data-surface="B"] { grid-area: B; } .surface[data-surface="L"] { grid-area: L; }

        /* State Colors/Styles */
        .surface.supra { background-color: rgba(0, 128, 0, 0.2); } .surface.sub { background-color: rgba(0, 0, 255, 0.2); }
        .surface.both { background-color: rgba(255, 165, 0, 0.2); } .surface.plaque { border: 3px solid #ff80ab !important; }

        /* Comparison Highlight Styles */
        .surface.diff-faculty2 { background-color: rgba(128, 0, 128, 0.4) !important; }
        .surface.diff-faculty1 { background-color: rgba(255, 0, 0, 0.4) !important; }

        /* Active states for comparison buttons */
        .action-button.active-compare-f1 { background-color: rgba(255, 0, 0, 0.4); color: white; border: 1px solid rgba(200, 0, 0, 0.6); }
        .action-button.active-compare-f2 { background-color: rgba(128, 0, 128, 0.4); color: white; border: 1px solid rgba(100, 0, 100, 0.6); }
        .action-button.active-compare-both { background-color: rgba(255, 0, 0, 0.4); color: white; border: 1px solid rgba(200, 0, 0, 0.6); }

        /* Comparison Controls Area */
        #comparison-controls {
            text-align: center; margin: 20px auto; max-width: 600px; padding: 15px;
            border: 1px dashed #ccc; border-radius: 8px;
            display: flex; /* Better alignment for buttons */
            flex-wrap: wrap; /* Allow buttons to wrap */
            justify-content: center; /* Center wrapped buttons */
            gap: 10px;
        }
        /* PDF Download & Lock Button Area */
         #pdf-controls {
             text-align: center; margin: 10px 0 30px 0;
             display: flex; /* Better alignment for buttons */
             flex-wrap: wrap; /* Allow buttons to wrap */
             justify-content: center; /* Center wrapped buttons */
             gap: 10px;
        }

        /* Styles for Hiding/Showing Faculty 2 */
        #faculty2-container { display: none; } #faculty2-container.visible { display: block; }
        .f2-compare-button { display: none; } .f2-compare-button.visible { display: inline-block; }

        /* Hide controls when printing PDF */
        @media print { /* Use @media print for better control */
            .main-title,
            #patient-info,
            #comparison-controls,
            #pdf-controls,
            #toggle-f2-div { /* Hide the toggle button container too */
                display: none !important;
            }
             body { margin: 0; } /* Remove body margin for printing */
             .container-scaler { width: 100%; max-width: none; padding: 0; margin: 0;}
             .chart-container { border: none; padding: 5px; margin-bottom: 10px; }
             .quadrant { border: 1px solid #ccc; } /* Keep quadrant border */
             .chart-layout { gap: 5px; grid-template-columns: 1fr 1fr; } /* Maintain grid for print */
        }

        .pdf-generating .main-title, /* Also hide main title *during* generation if desired */
        .pdf-generating #patient-info, /* Hide patient info div during generation */
        .pdf-generating #comparison-controls,
        .pdf-generating #pdf-controls,
        .pdf-generating #toggle-f2-div { /* Hide toggle button container during generation */
             display: none !important;
        }


         /* Optional: Adjust chart layout on medium screens if needed */
        @media (max-width: 800px) {
             .chart-layout {
                 grid-template-columns: 1fr; /* Stack quadrants vertically */
             }
             #patient-info {
                 flex-direction: column; /* Stack patient info items vertically */
                 align-items: flex-start; /* Align labels left */
                 width: auto; /* Allow natural width */
             }
             #patient-info label {
                 margin-right: 0;
                 margin-bottom: 3px;
             }
             #patient-info input {
                 width: 90%; /* Make inputs wider on small screens */
             }
        }


    </style>
</head>
<body>

    <!-- NEW: Main Title -->
    <h1 class="main-title">Calculus Detection Chart</h1>

    <!-- NEW: Patient Info Section -->
    <div id="patient-info">
        <div> <!-- Wrap label/input pairs for better flex/wrap control -->
            <label for="patient-id">Patient ID:</label>
            <input type="text" id="patient-id" name="patient-id">
        </div>
        <div>
            <label for="chart-date">Date:</label>
            <input type="date" id="chart-date" name="chart-date"> <!-- Using type="date" for convenience -->
        </div>
    </div>


    <div class="container-scaler">

        <!-- Student Chart Area -->
        <div class="chart-container" id="student-container">
            <h2>Student Chart</h2>
            <div class="toggle-area" id="student-toggle-area"></div>
            <div class="chart-layout" id="student-chart"></div>
        </div>

        <!-- Comparison Controls Area -->
        <div id="comparison-controls">
            <button id="compare-f1-btn" class="action-button">Compare w/ Faculty 1</button>
            <button id="compare-f2-btn" class="f2-compare-button action-button">Compare w/ Faculty 2</button>
            <button id="compare-both-btn" class="f2-compare-button action-button">Compare w/ Both</button>
            <button id="clear-compare-btn" class="action-button">Clear Comparison Highlights</button>
        </div>

        <!-- PDF Download & Lock Controls -->
         <div id="pdf-controls">
             <button id="download-pdf-btn" class="action-button">Download Chart as PDF</button>
             <button id="lock-chart-btn" class="action-button">Lock Charts</button>
         </div>


        <!-- Faculty Check 1 Chart Area -->
        <div class="chart-container" id="faculty1-container">
            <h2>Faculty Check 1</h2>
            <div class="toggle-area" id="faculty1-toggle-area"></div>
            <div class="chart-layout" id="faculty1-chart"></div>
        </div>

         <!-- Toggle Button for Faculty 2 -->
         <div style="text-align: center; margin-bottom: 20px;" id="toggle-f2-div">
             <button id="toggle-f2-btn" class="action-button">Show Faculty Check 2</button>
        </div>


        <!-- Faculty Check 2 Chart Area (Initially hidden via CSS) -->
        <div class="chart-container" id="faculty2-container">
            <h2>Faculty Check 2</h2>
            <div class="toggle-area" id="faculty2-toggle-area"></div>
            <div class="chart-layout" id="faculty2-chart"></div>
        </div>

    </div><!-- End Scaler -->

    <script>
        // Wrap entire script in an IIFE
        (function() {
            'use strict';

            const { jsPDF } = window.jspdf;

            // --- Constants and Configuration ---
            const SYMBOLS = ["", "L", "M", "S"]; // Using L/M/S for Light/Moderate/Severe? Adjust if needed.
            const QUADRANT_ORDER = ['Upper Right', 'Upper Left', 'Lower Right', 'Lower Left']; // Adjusted to match visual layout typically
            const QUADRANTS = {
                 'Upper Right': [1, 2, 3, 4, 5, 6, 7, 8], 'Upper Left': [9, 10, 11, 12, 13, 14, 15, 16],
                 'Lower Right': [32, 31, 30, 29, 28, 27, 26, 25], 'Lower Left': [17, 18, 19, 20, 21, 22, 23, 24] // Reversed Lower Right for typical chart flow
            };
             // Match grid position to QUADRANT_ORDER
             const QUADRANT_POS = {
                 'Upper Right': { col: 1, row: 1 }, 'Upper Left': { col: 2, row: 1 },
                 'Lower Right': { col: 1, row: 2 }, 'Lower Left': { col: 2, row: 2 }
             };

            const SURFACES = ['M', 'D', 'B', 'L']; // Mesial, Distal, Buccal, Lingual
            const CHART_IDS = ['student', 'faculty1', 'faculty2'];
            const ALL_TOOTH_NUMBERS = [].concat(...Object.values(QUADRANTS)).flat().sort((a, b) => a - b); // Ensure all numbers 1-32 are covered and sorted
            const UNLOCK_CODE = "12345";
            const PDF_TITLE = "Calculus Detection Chart"; // Title for PDF

            // --- State Variables ---
            let chartData = {};
            let chartModes = {};
            let areChartsLocked = false;

            // --- DOM Element Cache ---
            const domElements = {
                chartContainers: {}, toggleAreas: {}, chartLayouts: {},
                compareF1Btn: null, compareF2Btn: null, compareBothBtn: null, clearCompareBtn: null,
                toggleF2Btn: null, faculty2Container: null, f2CompareButtons: null,
                pdfButton: null, lockChartBtn: null, studentChartLayout: null,
                patientInfoContainer: null, patientIdInput: null, chartDateInput: null,
                toggleF2Div: null // Cache the div containing the toggle button
            };

            /** Initializes the data structures and lock state. */
            function initializeState() {
                areChartsLocked = false;
                CHART_IDS.forEach(chartId => {
                    chartData[chartId] = {};
                    // Defaulting 'calc' to 0 (none), 'plaque' to false, 'calcType' to null initially
                    chartModes[chartId] = { currentLoc: 'supra', plaqueMode: false }; // 'supra', 'sub', 'both' track the type being applied
                    ALL_TOOTH_NUMBERS.forEach(toothNum => {
                        chartData[chartId][toothNum] = {};
                        SURFACES.forEach(surface => {
                             // calc: 0=None, 1=Light, 2=Moderate, 3=Severe ? Match SYMBOLS index
                             chartData[chartId][toothNum][surface] = { calc: 0, plaque: false, calcType: null };
                        });
                    });
                });
                 // Set default date
                 if(domElements.chartDateInput && !domElements.chartDateInput.value) {
                     try {
                        // Format date as YYYY-MM-DD for input type="date"
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = String(today.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
                        const day = String(today.getDate()).padStart(2, '0');
                        domElements.chartDateInput.value = `${year}-${month}-${day}`;
                     } catch(e) {
                         console.warn("Could not set default date.");
                     }
                 }
            }

             /** Updates the visual appearance of a single tooth surface cell. */
             function updateCellUI(chartId, toothNum, surface) {
                 const cellSelector = `.surface[data-chart-id="${chartId}"][data-tooth-num="${toothNum}"][data-surface="${surface}"]`;
                 const chartLayout = domElements.chartLayouts[chartId];
                 const cell = chartLayout ? chartLayout.querySelector(cellSelector) : null;
                 if (!cell) {
                     // console.warn(`Cell not found: ${chartId}, ${toothNum}, ${surface}`);
                     return;
                 }
                 const data = chartData[chartId]?.[toothNum]?.[surface];
                 if (!data) {
                      // console.warn(`Data not found: ${chartId}, ${toothNum}, ${surface}`);
                      return;
                 }

                 // Update text based on 'calc' level (L/M/S)
                 cell.textContent = SYMBOLS[data.calc] || ""; // Use symbol based on calc level

                 // Remove old classes first
                 cell.classList.remove('supra', 'sub', 'both', 'plaque', 'diff-faculty1', 'diff-faculty2');

                 // Add class based on calcType if calc is present
                 if (data.calc > 0 && data.calcType) {
                     cell.classList.add(data.calcType);
                 }

                 // Add plaque class if plaque is true
                 if (data.plaque) {
                     cell.classList.add('plaque');
                 }
             }


             /** Creates the mode toggle buttons. */
             function createToggleButtons(chartId, toggleAreaElement) {
                 if (!toggleAreaElement) return;
                 toggleAreaElement.innerHTML = ''; // Clear existing buttons

                 const createButton = (mode, text, isPlaque = false) => {
                     const btn = document.createElement('button'); // Use button for semantics
                     btn.className = `toggle-btn ${mode}`;
                     btn.textContent = text;
                     btn.type = 'button'; // Prevent form submission if inside a form
                     btn.addEventListener('click', () => handleModeChange(chartId, mode, toggleAreaElement, isPlaque));
                     return btn;
                 };

                 // Create Calculus type buttons
                 const supraBtn = createButton('supra', 'Supra');
                 const subBtn = createButton('sub', 'Sub');
                 const bothBtn = createButton('both', 'Both');

                 // Create Plaque button
                 const plaqueBtn = createButton('plaque', 'Plaque', true);

                 // Append all buttons
                 toggleAreaElement.append(supraBtn, subBtn, bothBtn, plaqueBtn);

                 // Set initial active state based on chartModes
                 const currentMode = chartModes[chartId];
                 if (currentMode.plaqueMode) {
                     plaqueBtn.classList.add('active');
                 } else {
                     const activeCalcButton = toggleAreaElement.querySelector(`.toggle-btn.${currentMode.currentLoc}`);
                     if (activeCalcButton) {
                         activeCalcButton.classList.add('active');
                     } else {
                         // Default to supra if currentLoc is somehow invalid
                         supraBtn.classList.add('active');
                         chartModes[chartId].currentLoc = 'supra';
                     }
                 }
             }

             /** Handles clicks on the mode toggle buttons, preventing changes if locked. */
            function handleModeChange(chartId, mode, toggleAreaElement, isPlaque = false) {
                if (areChartsLocked) {
                    console.log("Charts are locked. Cannot change mode.");
                    return;
                }

                const currentChartMode = chartModes[chartId];
                const buttons = toggleAreaElement.querySelectorAll('.toggle-btn');
                buttons.forEach(btn => btn.classList.remove('active')); // Deactivate all buttons first

                const clickedButton = toggleAreaElement.querySelector(`.toggle-btn.${mode}`);

                if (isPlaque) {
                    // Toggle plaque mode
                    currentChartMode.plaqueMode = !currentChartMode.plaqueMode;
                    if (currentChartMode.plaqueMode) {
                        clickedButton.classList.add('active'); // Activate plaque button
                    } else {
                        // Plaque turned off, reactivate the last calculus button
                        const calcButton = toggleAreaElement.querySelector(`.toggle-btn.${currentChartMode.currentLoc}`);
                        if (calcButton) calcButton.classList.add('active');
                    }
                } else {
                    // Calculus mode selected
                    currentChartMode.plaqueMode = false; // Ensure plaque mode is off
                    currentChartMode.currentLoc = mode; // Set the current calculus type
                    clickedButton.classList.add('active'); // Activate the clicked calculus button
                }
                // console.log(`Chart ${chartId} mode changed:`, chartModes[chartId]);
            }


            /** Creates the HTML elements for a complete chart. */
            function createChartElements(chartId, chartLayoutElement) {
                if (!chartLayoutElement) return;
                chartLayoutElement.innerHTML = ''; // Clear previous content

                QUADRANT_ORDER.forEach(quadrantName => {
                    const pos = QUADRANT_POS[quadrantName];
                    const quadDiv = document.createElement('div');
                    quadDiv.className = 'quadrant';
                     // Apply grid positioning if the layout uses it (like the original 2x2)
                     // If using auto-fit, these might not be strictly necessary but don't hurt
                     if (pos) {
                         quadDiv.style.gridColumn = pos.col;
                         quadDiv.style.gridRow = pos.row;
                     }

                    const h3 = document.createElement('h3');
                    h3.textContent = quadrantName;
                    quadDiv.append(h3);

                    const toothGridDiv = document.createElement('div');
                    toothGridDiv.className = 'tooth-grid';

                    const teethNumbers = QUADRANTS[quadrantName];
                    if (!teethNumbers) {
                        console.error(`No teeth defined for quadrant: ${quadrantName}`);
                        return; // Skip this quadrant if no teeth defined
                    }

                    teethNumbers.forEach(num => {
                        const toothDiv = document.createElement('div');
                        toothDiv.className = 'tooth';

                        const label = document.createElement('label');
                        label.textContent = num;
                        toothDiv.append(label);

                        const surfaceGridDiv = document.createElement('div');
                        surfaceGridDiv.className = 'surface-grid';

                        SURFACES.forEach(s => {
                            const cell = document.createElement('div');
                            cell.className = 'surface';
                            cell.dataset.chartId = chartId;
                            cell.dataset.toothNum = num;
                            cell.dataset.surface = s;
                            // Set initial state via updateCellUI later
                            cell.addEventListener('click', handleSurfaceClick);
                            surfaceGridDiv.append(cell);
                        }); // End SURFACES.forEach

                        toothDiv.append(surfaceGridDiv);
                        toothGridDiv.append(toothDiv);
                    }); // End teethNumbers.forEach

                    quadDiv.append(toothGridDiv);
                    chartLayoutElement.append(quadDiv);
                }); // End QUADRANT_ORDER.forEach
            }


             /** Handles clicks on individual tooth surface cells, preventing changes if locked. */
            function handleSurfaceClick(event) {
                if (areChartsLocked) {
                    // console.log("Charts are locked. Cannot modify surface.");
                    return;
                }
                const cell = event.currentTarget;
                const { chartId, toothNum, surface } = cell.dataset;

                // Ensure data structure exists
                if (!chartData[chartId]?.[toothNum]?.[surface]) {
                    console.error(`Data missing for ${chartId}, Tooth ${toothNum}, Surface ${surface}`);
                    // Optionally initialize it here if it makes sense in your flow
                    // chartData[chartId][toothNum][surface] = { calc: 0, plaque: false, calcType: null };
                    return;
                }

                const mode = chartModes[chartId];
                const data = chartData[chartId][toothNum][surface];

                if (mode.plaqueMode) {
                    // Toggle plaque state
                    data.plaque = !data.plaque;
                } else {
                    // Cycle through calculus levels (0, 1, 2, 3, then back to 0)
                    data.calc = (data.calc + 1) % SYMBOLS.length;

                    // Update calcType only if calculus is present
                    if (data.calc > 0) {
                        data.calcType = mode.currentLoc; // 'supra', 'sub', or 'both'
                    } else {
                        // Reset calcType if calculus is removed (level 0)
                        data.calcType = null;
                    }
                    // Plaque state remains unchanged when clicking in calculus mode
                }

                updateCellUI(chartId, toothNum, surface);

                // If modifying student chart, clear comparison highlights on that cell
                if (chartId === 'student') {
                    cell.classList.remove('diff-faculty1', 'diff-faculty2');
                     // Also consider clearing the main comparison button active states if desired
                     // clearComparisonHighlights(); // Or just remove active classes from buttons
                }
                // console.log(`Clicked ${chartId}-${toothNum}-${surface}:`, data);
            }


            /** Clears all comparison highlights from the student chart and resets button states. */
            function clearComparisonHighlights() {
                if (!domElements.studentChartLayout) return;

                const surfacesToClear = domElements.studentChartLayout.querySelectorAll('.surface');
                surfacesToClear.forEach(cell => {
                    cell.classList.remove('diff-faculty1', 'diff-faculty2');
                    // Optionally force redraw if styles aren't clearing reliably
                    // updateCellUI('student', cell.dataset.toothNum, cell.dataset.surface);
                });

                // Remove active classes from comparison buttons
                domElements.compareF1Btn?.classList.remove('active-compare-f1');
                domElements.compareF2Btn?.classList.remove('active-compare-f2');
                domElements.compareBothBtn?.classList.remove('active-compare-both'); // Use a specific class if needed for 'both'

                console.log("Comparison highlights cleared.");
            }

             /** Runs comparison and highlights differences on the student chart. */
            function runComparison(compareF1, compareF2) {
                clearComparisonHighlights(); // Start fresh
                if (!domElements.studentChartLayout) return;

                console.log(`Running comparison: F1=${compareF1}, F2=${compareF2}`);

                let hasDifferences = false; // Track if any differences were found

                ALL_TOOTH_NUMBERS.forEach(toothNum => {
                    SURFACES.forEach(surface => {
                        const studentState = chartData.student?.[toothNum]?.[surface];
                        if (!studentState) return; // Skip if student data missing for this cell

                        let isDiffF1 = false;
                        let isDiffF2 = false;

                        // Compare with Faculty 1 if requested
                        if (compareF1 && chartData.faculty1?.[toothNum]?.[surface]) {
                            const f1State = chartData.faculty1[toothNum][surface];
                            // Compare both calculus level/type AND plaque state
                            if (studentState.calc !== f1State.calc || studentState.calcType !== f1State.calcType || studentState.plaque !== f1State.plaque) {
                                isDiffF1 = true;
                            }
                        }

                        // Compare with Faculty 2 if requested and visible
                        const faculty2Visible = domElements.faculty2Container?.classList.contains('visible');
                        if (compareF2 && faculty2Visible && chartData.faculty2?.[toothNum]?.[surface]) {
                            const f2State = chartData.faculty2[toothNum][surface];
                             // Compare both calculus level/type AND plaque state
                             if (studentState.calc !== f2State.calc || studentState.calcType !== f2State.calcType || studentState.plaque !== f2State.plaque) {
                                isDiffF2 = true;
                            }
                        }

                        // Apply highlight classes to the corresponding student cell
                        const cellSelector = `.surface[data-chart-id="student"][data-tooth-num="${toothNum}"][data-surface="${surface}"]`;
                        const cell = domElements.studentChartLayout.querySelector(cellSelector);

                        if (cell) {
                            // Remove previous diff classes specifically
                             cell.classList.remove('diff-faculty1', 'diff-faculty2');

                             // Apply new diff classes
                            if (isDiffF1) {
                                cell.classList.add('diff-faculty1');
                                hasDifferences = true;
                            }
                            // Use else if only if you want F2 diff to show ONLY if F1 is not different
                            // Otherwise, let F2 add its class regardless (allowing both highlights if styles permit)
                            if (isDiffF2) {
                                cell.classList.add('diff-faculty2');
                                hasDifferences = true;
                            }
                        }
                    }); // End SURFACES loop
                }); // End ALL_TOOTH_NUMBERS loop

                 // Update button active states based on which comparison was run
                 if (compareF1 && compareF2 && faculty2Visible) {
                     domElements.compareBothBtn?.classList.add('active-compare-both'); // Use a distinct class if desired
                 } else if (compareF1) {
                     domElements.compareF1Btn?.classList.add('active-compare-f1');
                 } else if (compareF2 && faculty2Visible) {
                     domElements.compareF2Btn?.classList.add('active-compare-f2');
                 }

                 if (!hasDifferences) {
                     console.log("No differences found.");
                     // Optionally show a message to the user
                 } else {
                    console.log("Differences highlighted.");
                 }
            }


            // --- PDF Generation ---
            async function generatePdf() {
                 if (!domElements.pdfButton || areChartsLocked) {
                     if(areChartsLocked) alert("Cannot generate PDF while charts are locked. Please unlock first.");
                     return;
                 }

                 console.log("Preparing for PDF generation...");

                 // Optional: Run comparison before generating PDF to include highlights
                 // const faculty2Visible = domElements.faculty2Container?.classList.contains('visible');
                 // runComparison(true, faculty2Visible); // Compare student with F1 and potentially F2

                 domElements.pdfButton.textContent = 'Generating PDF...';
                 domElements.pdfButton.disabled = true;
                 domElements.lockChartBtn.disabled = true; // Disable lock while generating
                 document.body.classList.add('pdf-generating'); // Add class to hide elements via CSS

                 // Get Patient Info Values
                 const patientId = domElements.patientIdInput?.value || 'N/A';
                 let chartDate = domElements.chartDateInput?.value || 'N/A';
                  // Optional: Reformat date if needed (e.g., from YYYY-MM-DD to MM/DD/YYYY)
                  // if (chartDate !== 'N/A' && domElements.chartDateInput?.type === 'date') {
                  //     try {
                  //         const dateParts = chartDate.split('-'); // YYYY, MM, DD
                  //         if (dateParts.length === 3) {
                  //             chartDate = `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`;
                  //         }
                  //     } catch (e) { console.warn("Could not reformat date."); }
                  // }

                 try {
                     const pdf = new jsPDF({
                         orientation: 'landscape', // Landscape might fit charts better side-by-side
                         unit: 'pt',             // Points are common for PDF sizing
                         format: 'a4'              // Standard A4 size
                     });
                     const pdfWidth = pdf.internal.pageSize.getWidth();
                     const pdfHeight = pdf.internal.pageSize.getHeight();
                     const margin = 30; // Page margin in points
                     const usableWidth = pdfWidth - 2 * margin;
                     const usableHeight = pdfHeight - 2 * margin;
                     let currentY = margin; // Track Y position on the PDF page

                     // --- Add Header Info ---
                     pdf.setFontSize(16);
                     pdf.setFont(undefined, 'bold');
                     pdf.text(PDF_TITLE, pdfWidth / 2, currentY, { align: 'center' });
                     currentY += 20; // Move down below title

                     pdf.setFontSize(10);
                     pdf.setFont(undefined, 'normal');
                     pdf.text(`Patient ID: ${patientId}`, margin, currentY);
                     pdf.text(`Date: ${chartDate}`, pdfWidth - margin, currentY, { align: 'right' });
                     currentY += 25; // Move down past info line, add buffer

                     // --- Function to add a chart element to PDF ---
                     async function addChartToPdf(chartContainerId, title) {
                         const element = document.getElementById(chartContainerId);
                         // Skip if element doesn't exist or is F2 and not visible
                         if (!element || (chartContainerId === 'faculty2-container' && !element.classList.contains('visible'))) {
                             return false; // Indicate chart was skipped
                         }

                         console.log(`Adding chart: ${title}`);

                         // Check if there's enough space on the current page
                         // This is a rough estimate; html2canvas height can vary.
                         // A more robust solution might always put each chart on a new page or use pdf.splitTextToSize.
                         const estElementHeight = element.offsetHeight * 0.75; // Scale factor for points conversion
                         if (currentY + estElementHeight + 30 > pdfHeight - margin) { // +30 for title space
                             pdf.addPage();
                             currentY = margin; // Reset Y for new page
                             // Re-add header info on new page if desired (optional)
                              pdf.setFontSize(10);
                              pdf.setFont(undefined, 'normal');
                              pdf.text(`Patient ID: ${patientId} (cont.)`, margin, currentY);
                              pdf.text(`Date: ${chartDate}`, pdfWidth - margin, currentY, { align: 'right' });
                              currentY += 25;
                         }

                         // Add chart title to PDF
                         pdf.setFontSize(12);
                         pdf.setFont(undefined, 'bold');
                         pdf.text(title, margin, currentY);
                         currentY += 15; // Space below title

                         try {
                            const canvas = await html2canvas(element, {
                                scale: 2, // Increase resolution
                                useCORS: true,
                                logging: false,
                                backgroundColor: '#ffffff' // Ensure background for transparency issues
                            });
                            const imgData = canvas.toDataURL('image/png');
                            const imgProps = pdf.getImageProperties(imgData);

                            // Calculate scaled image dimensions to fit usable width
                            const imgWidth = usableWidth;
                            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                            // Check if scaled image fits remaining height
                            if (currentY + imgHeight > pdfHeight - margin) {
                                pdf.addPage(); // Add new page if image too tall
                                currentY = margin; // Reset Y
                                // Re-add header info on new page
                                pdf.setFontSize(10);
                                pdf.setFont(undefined, 'normal');
                                pdf.text(`Patient ID: ${patientId} (cont.)`, margin, currentY);
                                pdf.text(`Date: ${chartDate}`, pdfWidth - margin, currentY, { align: 'right' });
                                currentY += 25;
                                // Re-add chart title on new page
                                pdf.setFontSize(12);
                                pdf.setFont(undefined, 'bold');
                                pdf.text(title, margin, currentY);
                                currentY += 15;
                            }

                            pdf.addImage(imgData, 'PNG', margin, currentY, imgWidth, imgHeight);
                            currentY += imgHeight + 20; // Move Y position down past the added image + buffer
                            return true; // Indicate chart was added

                         } catch (canvasError) {
                            console.error(`html2canvas failed for ${chartContainerId}:`, canvasError);
                             pdf.setFontSize(10);
                             pdf.setTextColor(255, 0, 0); // Red text for error
                             pdf.text(`Error rendering ${title}. See console.`, margin, currentY);
                             pdf.setTextColor(0, 0, 0); // Reset text color
                             currentY += 15;
                            return false; // Indicate chart failed
                         }
                     }

                     // --- Add Charts sequentially ---
                     await addChartToPdf('student-container', 'Student Chart');
                     await addChartToPdf('faculty1-container', 'Faculty Check 1');
                     await addChartToPdf('faculty2-container', 'Faculty Check 2'); // Will be skipped if not visible

                     // --- Save the PDF ---
                     const filename = `${PDF_TITLE.replace(/\s+/g, '_')}_${patientId}_${chartDate}.pdf`;
                     pdf.save(filename);
                     console.log(`PDF saved as ${filename}`);

                 } catch (error) {
                     console.error("Error generating PDF:", error);
                     alert("Sorry, an error occurred generating the PDF. Check the console for details.");
                 } finally {
                     // --- Cleanup ---
                     domElements.pdfButton.textContent = 'Download Chart as PDF';
                     // Only re-enable buttons if charts aren't meant to be locked
                     if (!areChartsLocked) {
                         domElements.pdfButton.disabled = false;
                         domElements.lockChartBtn.disabled = false;
                     }
                     document.body.classList.remove('pdf-generating'); // Remove class to show elements again
                     // Optional: Clear comparison highlights after PDF generation
                     // clearComparisonHighlights();
                 }
            }


            // --- Lock/Unlock Logic (Includes Patient Info) ---
            function lockAllCharts() {
                if (!domElements.lockChartBtn) return;
                areChartsLocked = true;

                // Lock Chart Containers
                CHART_IDS.forEach(id => {
                    const container = domElements.chartContainers[id];
                    // Lock only if container exists AND (it's not F2 OR it is F2 and visible)
                    if (container && (id !== 'faculty2' || container.classList.contains('visible'))) {
                        container.classList.add('locked');
                    }
                });

                // Lock Patient Info Section
                domElements.patientInfoContainer?.classList.add('locked');
                if (domElements.patientIdInput) domElements.patientIdInput.readOnly = true;
                if (domElements.chartDateInput) domElements.chartDateInput.readOnly = true;


                // Update Buttons State
                domElements.lockChartBtn.textContent = 'Unlock Charts';
                domElements.lockChartBtn.disabled = false; // Unlock button should always be enabled when locked
                domElements.pdfButton.disabled = true; // Cannot generate PDF when locked
                // Disable comparison buttons when locked
                domElements.compareF1Btn.disabled = true;
                domElements.compareF2Btn.disabled = true;
                domElements.compareBothBtn.disabled = true;
                domElements.clearCompareBtn.disabled = true;
                 // Disable F2 toggle button when locked
                 domElements.toggleF2Btn.disabled = true;

                console.log("All active charts and info LOCKED.");
            }

            function unlockAllCharts() {
                 if (!domElements.lockChartBtn) return;
                 const enteredCode = prompt("Enter unlock code:");
                 if (enteredCode === null) return; // User cancelled prompt

                 if (enteredCode === UNLOCK_CODE) {
                    areChartsLocked = false;

                    // Unlock Chart Containers
                    CHART_IDS.forEach(id => {
                        domElements.chartContainers[id]?.classList.remove('locked');
                    });

                    // Unlock Patient Info Section
                    domElements.patientInfoContainer?.classList.remove('locked');
                    if (domElements.patientIdInput) domElements.patientIdInput.readOnly = false;
                    if (domElements.chartDateInput) domElements.chartDateInput.readOnly = false;

                    // Update Buttons State
                    domElements.lockChartBtn.textContent = 'Lock Charts';
                    domElements.lockChartBtn.disabled = false; // Lock button is enabled
                    domElements.pdfButton.disabled = false; // PDF download enabled
                    // Enable comparison buttons
                    domElements.compareF1Btn.disabled = false;
                    domElements.compareF2Btn.disabled = false; // State might depend if F2 is visible, but enable generally
                    domElements.compareBothBtn.disabled = false;
                    domElements.clearCompareBtn.disabled = false;
                    // Enable F2 toggle button
                    domElements.toggleF2Btn.disabled = false;

                    console.log("All charts and info UNLOCKED.");
                 } else {
                     alert("Incorrect code. Charts remain locked.");
                 }
            }


            // --- Setup Functions ---

            /** Finds and stores references to key DOM elements. */
            function cacheDomElements() {
                CHART_IDS.forEach(id => {
                    domElements.chartContainers[id] = document.getElementById(`${id}-container`);
                    domElements.toggleAreas[id] = document.getElementById(`${id}-toggle-area`);
                    domElements.chartLayouts[id] = document.getElementById(`${id}-chart`);
                });
                domElements.compareF1Btn = document.getElementById('compare-f1-btn');
                domElements.compareF2Btn = document.getElementById('compare-f2-btn');
                domElements.compareBothBtn = document.getElementById('compare-both-btn');
                domElements.clearCompareBtn = document.getElementById('clear-compare-btn');
                domElements.toggleF2Btn = document.getElementById('toggle-f2-btn');
                domElements.faculty2Container = document.getElementById('faculty2-container');
                domElements.f2CompareButtons = document.querySelectorAll('.f2-compare-button'); // Selects buttons with this class
                domElements.pdfButton = document.getElementById('download-pdf-btn');
                domElements.lockChartBtn = document.getElementById('lock-chart-btn');
                domElements.studentChartLayout = document.getElementById('student-chart'); // Specific layout for comparisons
                domElements.patientInfoContainer = document.getElementById('patient-info');
                domElements.patientIdInput = document.getElementById('patient-id');
                domElements.chartDateInput = document.getElementById('chart-date');
                domElements.toggleF2Div = document.getElementById('toggle-f2-div'); // Cache div containing F2 toggle
            }

             /** Creates the initial UI for all charts & sets initial lock state UI. */
            function setupChartUI() {
                CHART_IDS.forEach(id => {
                    createToggleButtons(id, domElements.toggleAreas[id]); // Create toggles first
                    createChartElements(id, domElements.chartLayouts[id]); // Then create chart structure
                    // Now populate cells based on initial state
                    if (chartData[id]) {
                        ALL_TOOTH_NUMBERS.forEach(toothNum => {
                            SURFACES.forEach(surface => {
                                if (chartData[id][toothNum]?.[surface]) {
                                    updateCellUI(id, toothNum, surface);
                                }
                            });
                        });
                    }
                });

                // Initialize lock state UI correctly based on 'areChartsLocked' (should be false initially)
                const isInitiallyLocked = areChartsLocked;
                if (domElements.lockChartBtn) {
                    domElements.lockChartBtn.textContent = isInitiallyLocked ? 'Unlock Charts' : 'Lock Charts';
                    domElements.lockChartBtn.disabled = false; // Lock/Unlock button should always be interactive
                }

                 // Apply initial locked classes and readOnly attributes
                 CHART_IDS.forEach(id => domElements.chartContainers[id]?.classList.toggle('locked', isInitiallyLocked));
                 domElements.patientInfoContainer?.classList.toggle('locked', isInitiallyLocked);
                 if(domElements.patientIdInput) domElements.patientIdInput.readOnly = isInitiallyLocked;
                 if(domElements.chartDateInput) domElements.chartDateInput.readOnly = isInitiallyLocked;

                 // Set initial disabled state for other buttons based on lock state
                 domElements.pdfButton.disabled = isInitiallyLocked;
                 domElements.compareF1Btn.disabled = isInitiallyLocked;
                 domElements.compareF2Btn.disabled = isInitiallyLocked;
                 domElements.compareBothBtn.disabled = isInitiallyLocked;
                 domElements.clearCompareBtn.disabled = isInitiallyLocked;
                 domElements.toggleF2Btn.disabled = isInitiallyLocked; // Also disable F2 toggle if locked initially
            }

            /** Attaches event listeners to the comparison control buttons. */
            function setupComparisonControls() {
                 if (!domElements.compareF1Btn || !domElements.compareF2Btn || !domElements.compareBothBtn || !domElements.clearCompareBtn) {
                     console.warn("One or more comparison buttons not found.");
                     return;
                 }

                domElements.compareF1Btn.addEventListener('click', () => {
                    if (!areChartsLocked) runComparison(true, false);
                });

                domElements.compareF2Btn.addEventListener('click', () => {
                    if (!areChartsLocked) {
                         if (domElements.faculty2Container?.classList.contains('visible')) {
                             runComparison(false, true);
                         } else {
                             alert("Please show Faculty Check 2 chart first to compare with it.");
                         }
                     }
                 });

                 domElements.compareBothBtn.addEventListener('click', () => {
                     if (!areChartsLocked) {
                         if (domElements.faculty2Container?.classList.contains('visible')) {
                             runComparison(true, true);
                         } else {
                              alert("Please show Faculty Check 2 chart first to compare with both.");
                         }
                    }
                 });

                domElements.clearCompareBtn.addEventListener('click', () => {
                     if (!areChartsLocked) clearComparisonHighlights();
                 });
            }

            /** Attaches event listener for toggling the Faculty 2 chart visibility and lock state. */
            function setupFaculty2Toggle() {
                if (!domElements.toggleF2Btn || !domElements.faculty2Container || !domElements.f2CompareButtons) {
                    console.error("Could not find all elements needed for F2 toggle functionality.");
                    // Hide the toggle button container if setup fails
                    if(domElements.toggleF2Div) domElements.toggleF2Div.style.display = 'none';
                    return;
                }

                domElements.toggleF2Btn.addEventListener('click', () => {
                    // Do not toggle if charts are locked
                     if (areChartsLocked) {
                         console.log("Charts are locked. Cannot toggle Faculty 2 visibility.");
                         return;
                     }

                    const f2Container = domElements.faculty2Container;
                    const f2Buttons = domElements.f2CompareButtons; // NodeList of buttons
                    const toggleBtn = domElements.toggleF2Btn;

                    // Toggle visibility class on the container
                    f2Container.classList.toggle('visible');
                    const isVisible = f2Container.classList.contains('visible');

                    // Toggle visibility class on the specific F2 comparison buttons
                    f2Buttons.forEach(btn => btn.classList.toggle('visible', isVisible));

                    // Update the toggle button text
                    toggleBtn.textContent = isVisible ? 'Hide Faculty Check 2' : 'Show Faculty Check 2';

                    // If hiding F2, clear any comparison highlights that involved F2
                    if (!isVisible) {
                        const f2Active = domElements.compareF2Btn?.classList.contains('active-compare-f2');
                        const bothActive = domElements.compareBothBtn?.classList.contains('active-compare-both'); // Check if 'both' comparison was active
                        if (f2Active || bothActive) {
                             // If F1 comparison is active, re-run it without F2
                            if (domElements.compareF1Btn?.classList.contains('active-compare-f1') || bothActive) {
                                 runComparison(true, false); // Re-run comparison with only F1
                             } else {
                                 clearComparisonHighlights(); // Otherwise, just clear all highlights
                             }
                        }
                         // Ensure F2 and Both buttons are not stuck in active state if F2 is hidden
                         domElements.compareF2Btn?.classList.remove('active-compare-f2');
                         domElements.compareBothBtn?.classList.remove('active-compare-both');
                    }

                    console.log(`Faculty 2 chart visibility toggled: ${isVisible ? 'Visible' : 'Hidden'}`);
                });
            }


            /** Attaches event listener to the PDF download button. */
            function setupPdfButton() {
                if (!domElements.pdfButton) { console.error("PDF button not found."); return; }
                // Add check inside listener to prevent generation if locked
                domElements.pdfButton.addEventListener('click', generatePdf);
            }

            /** Attaches event listener to the Lock/Unlock button. */
            function setupLockUnlockButton() {
                if (!domElements.lockChartBtn) { console.error("Lock/Unlock button not found."); return; }
                domElements.lockChartBtn.addEventListener('click', () => {
                    // No need to check areChartsLocked here, the functions handle the logic
                    if (areChartsLocked) {
                        unlockAllCharts();
                    } else {
                        lockAllCharts();
                    }
                });
            }

            // --- Initialization ---
            function init() {
                console.log("Initializing Chart Application...");
                cacheDomElements();     // Find elements first
                initializeState();      // Setup data structures
                setupChartUI();         // Build the HTML chart elements and apply initial state/styles
                setupComparisonControls(); // Attach listeners to comparison buttons
                setupFaculty2Toggle();   // Attach listener to F2 toggle button
                setupPdfButton();        // Attach listener to PDF button
                setupLockUnlockButton(); // Attach listener to Lock/Unlock button
                console.log("Initialization complete.");
            }

            // --- Run ---
            // Use DOMContentLoaded to ensure HTML is parsed before script runs
            document.addEventListener('DOMContentLoaded', init);

        })(); // End of IIFE
    </script>

</body>
</html>
